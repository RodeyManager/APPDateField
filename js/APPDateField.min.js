/**
 * Created with JetBrains WebStorm.
 * User: LUOYONG （Rodey -- www.senuu.com）
 * Date: 14-4-1
 * Time: 下午5:40
 * QQ:   453474593
 * To change this template use File | Settings | File Templates.
 */

/**
 * USE:
 * <input type="text" id="date" readonly class="date-input">
 *
 * var appDateField = new APPDateField('date', {
            isCN: true,       //是否显示中文, 如: " 2014年4月1日 "
            isListType: true, //日期列表中是否需要显示 ‘年月日’
            commer: '/',      //期间之间的间隔符, 默认为 "/"，当 isCN为 true时, 这个设置失效
            showYear: true,   //是否显示年份, 默认为显示 （true）
            showMonth: true,  //是否显示月份, 默认为显示 （true）
            showDate: true,   //是否显示日, 默认为显示 （true）
            showTime: false,     //是否组件为时间选择，true：'16:20:25' 如果isCN为true，则："16时20分25秒".这个开启建议将isCN设置为false
            complate: function(evt){  // "完成"按钮触发事件
                console.log(this)
                console.log(this.getCurrentDate(0,0,0));
                console.log(this.currDate);
            },
            cancel: function(evt){  // "取消"按钮触发事件
                console('Cancel---');
            }
        });
 */

(function(){var rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60)};var root=this;var ddCache=[];var gVars={fontSize:22,step:40,isCircle:false,tpl:'<div class="app-dateField-main">'+'<div class="app-dateField-top">'+'<span class="app-dateField-btnCancel">取消</span>'+'<span class="app-dateField-title">选择时间</span>'+'<span class="app-dateField-btnOk">完成</span>'+"</div>"+'<div class="app-dateField-center">'+'<ul class="app-dateField-year-con"></ul>'+'<ul class="app-dateField-month-con"></ul>'+'<ul class="app-dateField-date-con"></ul>'+'<div class="app-center-current"></div>'+"</div>"+'<div class="app-dateField-bottom"></div>'+"</div>"};var APPDateField=function(selectElm,options,complate,cancel){var self=this;var options=options||{};self.selectElm=(typeof selectElm==="string")?document.getElementById(selectElm):selectElm;self.htmlDom=null;self.appWrap=$?$("#APPDateField-con")[0]:document.getElementById("APPDateField-con");self.loaded=false;self.isRender=false;if((options.complate&&options.complate!=undefined&&typeof options.complate==="function")||(complate&&typeof complate==="function")){self.complate=options.complate?options.complate:complate}if((options.cancel&&options.cancel!=undefined&&typeof options.cancel==="function")||(cancel&&typeof cancel==="function")){self.cancel=options.cancel?options.cancel:cancel}self.currentTop=0;self.step=gVars.step;self.valList=[];self.currDate=[];self.app_top;self.app_btnCancel;self.app_btnOk;self.app_center_con;self.app_y_con;self.app_m_con;self.app_d_con;self.app_cen_c;self.opts={year:new Date().getFullYear(),month:new Date().getMonth()+1,date:new Date().getDate(),hours:new Date().getHours(),minutes:new Date().getMinutes(),seconds:new Date().getSeconds(),upYear:options.upYear||100,downYear:options.downYear||100,isCN:(!options.isCN&&undefined!=options.isCN)?options.isCN:true,isListType:(!options.isListType&&undefined!=options.isListType)?options.isCN:true,isVal:(!options.isVal&&undefined!=options.isVal)?options.isVal:false,isCircle:(!options.isCircle&&undefined!=options.isCircle)?options.isCircle:false,showYear:(!options.showYear&&undefined!=options.showYear)?options.showYear:true,showMonth:(!options.showMonth&&undefined!=options.showMonth)?options.showMonth:true,showDate:(!options.showDate&&undefined!=options.showDate)?options.showDate:true,showTime:options.showTime||false,commer:options.commer||"-"};gVars.isCircle=self.opts.isCircle;self._init()};APPDateField.prototype._init=function(){var self=this;var value="";if(self.selectElm.tagName=="INPUT"){value=self.selectElm.value}else{value=self.selectElm.innerHTML}if(value||value!==""){if(!self.opts.showTime){value=""}self.valList=self.subDefaultDate(value||"")}self.setCurrentTXT(self.valList);if(!self.appWrap){self.appWrap=document.createElement("div");self.appWrap.setAttribute("id","APPDateField-con");self.appWrap.setAttribute("class","APPDateField-con");document.body.appendChild(self.appWrap)}else{$?($(self.appWrap).show()):(self.appWrap.style.display="block");self.isRender=true}self._load()};APPDateField.prototype._load=function(){var self=this;if(!self.loaded){}self._render()};APPDateField.prototype._render=function(){var self=this;var appWrap=$(self.appWrap).html(gVars.tpl);var htmlDomS=appWrap;self.htmlDom=appWrap;self.app_main=appWrap.find(".app-dateField-main");self.app_top=appWrap.find(".app-dateField-top");self.app_btnCancel=appWrap.find(".app-dateField-btnCancel");self.app_btnOk=appWrap.find(".app-dateField-btnOk");self.app_center_con=appWrap.find(".app-dateField-center");self.app_y_con=appWrap.find(".app-dateField-year-con");self.app_m_con=appWrap.find(".app-dateField-month-con");self.app_d_con=appWrap.find(".app-dateField-date-con");self.app_cen_c=appWrap.find(".app-center-current");self.app_center_con.find("ul").css({"width":appWrap.width()/3});if(self.opts.showYear&&self.opts.showMonth&&!self.opts.showDate){self.app_center_con.find("ul").css({"width":appWrap.width()/2});self.app_y_con.css({left:0});self.app_m_con.css({left:appWrap.width()/2});self.app_d_con.css({left:appWrap.width()/2*2,display:"none"})}else{if(!self.opts.showYear&&self.opts.showMonth&&self.opts.showDate){self.app_center_con.find("ul").css({"width":appWrap.width()/2});self.app_y_con.css({left:0,display:"none"});self.app_m_con.css({left:0});self.app_d_con.css({left:appWrap.width()/2})}else{if(self.opts.showYear&&self.opts.showMonth&&self.opts.showDate){self.app_y_con.css({left:0});self.app_m_con.css({left:appWrap.width()/3});self.app_d_con.css({left:appWrap.width()/3*2})}}}self.loaded=true;if(self.opts.showTime){self.createHours();self.createMins();self.createSeconds()}else{self.createYear();self.createMonth();self.createDate()}self._events()};APPDateField.prototype.createYear=function(up,down){var self=this;var up=up||self.opts.upYear;var down=down||self.opts.downYear;var now=new Date();var ny=now.getFullYear();var html=[];var li="";var style="";if(self.loaded){for(var j=1;j<up+1;j++){li=self.opts.isListType?"<li"+style+">"+(ny-j)+"年</li>":"<li>"+(ny-j)+"</li>";html.unshift(li)}for(var i=0;i<=down;i++){li=self.opts.isListType?"<li"+style+">"+(ny+i)+"年</li>":"<li>"+self.dateFm((ny+i))+"</li>";html.push(li)}self.app_y_con.html(html.join(""))}self.currentTop=self.step*(self.opts.year-parseInt(self.app_y_con.find("li").eq(0).text())-3);self._scrollTop(self.app_y_con,-self.currentTop,true)};APPDateField.prototype.createMonth=function(){var self=this;var now=new Date();var nm=self.dateFm(now.getMonth()+1);var m=1;var html=[];var li="";if(self.loaded){while(m<13){li=self.opts.isListType?"<li>"+m+"月</li>":"<li>"+self.dateFm(m)+"</li>";html.push(li);m++}self.app_m_con.html(html.join(""))}self._scrollTop(self.app_m_con,-(self.step*parseInt(self.opts.month)-(self.step*4)),true)};APPDateField.prototype.createDate=function(){var self=this;var now=new Date();var ny=now.getFullYear(),nm=self.dateFm(now.getMonth()+1),nd=self.dateFm(now.getDate());var d=0,pr=31;var html=[];var li="";if(self.loaded){if(self.opts.month==2){pr=(((self.opts.year%4==0)&&(self.opts.year%100!=0))||(self.opts.year%400==0))?29:28;while(d<31){if(d>=pr){li=self.opts.isListType?'<li style="display:none;">'+(d+1)+"日</li>":'<li style="display:none;">'+self.dateFm((d+1))+"</li>"}else{li=self.opts.isListType?"<li>"+(d+1)+"日</li>":"<li>"+self.dateFm((d+1))+"</li>"}html.push(li);d++}}else{while(d<31){li=self.opts.isListType?"<li>"+(d+1)+"日</li>":"<li>"+self.dateFm((d+1))+"</li>";html.push(li);d++}}self.app_d_con.html(html.join(""))}self._scrollTop(self.app_d_con,-(self.step*parseInt(self.opts.date)-(self.step*4)),true)};APPDateField.prototype.createHours=function(){var self=this;var html=[];var li="";var i=0;if(self.loaded){while(i<24){li=self.opts.isListType?"<li>"+i+"时</li>":"<li>"+self.dateFm(i)+"</li>";html.push(li);i++}self.app_y_con.html(html.join(""))}self.currentTop=self.step*(self.opts.hours-parseInt(self.app_y_con.find("li").eq(0).text())-3);self._scrollTop(self.app_y_con,-self.currentTop,true)};APPDateField.prototype.createMins=function(){var self=this;var html=[];var li="";var i=0;if(self.loaded){while(i<60){li=self.opts.isListType?"<li>"+i+"分</li>":"<li>"+self.dateFm(i)+"</li>";html.push(li);i++}self.app_m_con.html(html.join(""))}self._scrollTop(self.app_m_con,-(self.step*parseInt(self.opts.minutes+1)-(self.step*4)),true)};APPDateField.prototype.createSeconds=function(){var self=this;var html=[];var li="";var i=0;if(self.loaded){while(i<60){li=self.opts.isListType?"<li>"+i+"秒</li>":"<li>"+self.dateFm(i)+"</li>";html.push(li);i++}self.app_d_con.html(html.join(""))}self._scrollTop(self.app_d_con,-(self.step*parseInt(self.opts.seconds+1)-(self.step*4)),true)};APPDateField.prototype.getYear=function(){this.year=parseInt(this.getCurrentTXT(this.app_y_con));return this.year};APPDateField.prototype.setYear=function(year){this.year=year};APPDateField.prototype.getMonth=function(){this.month=parseInt(this.getCurrentTXT(this.app_m_con));return this.month};APPDateField.prototype.setMonth=function(month){this.month=month};APPDateField.prototype.getDate=function(){this.date=parseInt(this.getCurrentTXT(this.app_d_con));return this.date};APPDateField.prototype.setDate=function(date){this.date=date};APPDateField.prototype.getCurrentTXT=function(moveEL){var num=Math.round(moveEL.position().top)/this.step;if(num==0){num=3}else{if(num>=1&&num<=3){if(num==1){num=2}else{if(num==2){num=1}else{if(num==3){num=0}}}}else{if(num<0){num=Math.abs(num)+3}}}var currentTXT=moveEL.find("li").eq(num).text();return currentTXT};APPDateField.prototype.setCurrentTXT=function(valList){var self=this;var vlist=valList;if(vlist&&vlist.length>0){if(self.opts.showTime){self.opts.hours=isNaN(parseInt(vlist[0]))?self.opts.hours:parseInt(vlist[0]);self.opts.minutes=isNaN(parseInt(vlist[1]))?self.opts.minutes:parseInt(vlist[1]);self.opts.seconds=isNaN(parseInt(vlist[2]))?self.opts.seconds:parseInt(vlist[2])}else{if(!self.opts.showYear){vlist[0]=""}if(!self.opts.showDate){vlist[2]=""}self.opts.year=isNaN(parseInt(vlist[0]))?self.opts.year:parseInt(vlist[0]);self.opts.month=isNaN(parseInt(vlist[1]))?self.opts.month:parseInt(vlist[1]);self.opts.date=isNaN(parseInt(vlist[2]))?self.opts.date:parseInt(vlist[2])}}var dateStr,dy,dm,dd;if(self.opts.showTime){dy=self.opts.isCN?(self.opts.hours+"时"):(self.opts.hours+":"),dm=self.opts.isCN?(self.opts.minutes+"分"):(self.dateFm(self.opts.minutes)+":"),dd=self.opts.isCN?(self.opts.seconds+"秒"):(self.dateFm(self.opts.seconds));dateStr=dy+dm+dd}else{dy=self.opts.isCN?(self.opts.year+"年"):(self.opts.year+self.opts.commer),dm=self.opts.isCN?(self.opts.month+"月"):(self.dateFm(self.opts.month)+self.opts.commer),dd=self.opts.isCN?(self.opts.date+"日"):(self.dateFm(self.opts.date));if(self.opts.showYear&&self.opts.showMonth&&!self.opts.showDate){dy=self.opts.isCN?(self.opts.year+"年"):(self.opts.year+self.opts.commer);dm=self.opts.isCN?(self.opts.month+"月"):(self.dateFm(self.opts.month));dd="";dateStr=dy+dm}else{if(!self.opts.showYear&&self.opts.showMonth&&self.opts.showDate){dy="";dm=self.opts.isCN?(self.opts.month+"月"):(self.dateFm(self.opts.month)+self.opts.commer);dd=self.opts.isCN?(self.opts.date+"日"):(self.dateFm(self.opts.date));dateStr=dm+dd}else{dateStr=dy+dm+dd}}}if(self.selectElm.tagName=="INPUT"){self.selectElm.value=dateStr}else{self.selectElm.innerHTML=dateStr}};APPDateField.prototype.subDefaultDate=function(dateString){var self=this,list=[];if(!dateString&&dateString==""){var date=new Date();if(self.opts.showTime){list.push(date.getHours());list.push(date.getMinutes());list.push(date.getSeconds())}else{list.push(date.getFullYear());list.push(date.getMonth()+1);list.push(date.getDate())}}else{if(self.opts.isCN){list=dateString.match(/(\d)+/gi)}else{list=dateString.match(/(\d)+/gi)||dateString.split(self.opts.commer||"-")}}if(list.length==3){if(!self.opts.showYear){list[0]=""}if(!self.opts.showDate){list[2]=""}}else{if(!self.opts.showYear){list.unshift("")}if(!self.opts.showDate){list.push("")}}console.log(list);self.valList=list;return list};APPDateField.prototype.getCurrentDate=function(y,m,d,commer){var list=this.currDate;(!y||y==undefined||y==null||y==0)?y=list[0]:y;(!m||m==undefined||m==null||m==0)?m=list[1]:m;(!d||d==undefined||d==null||d==0)?d=list[2]:d;list[0]=y;list[1]=m;list[2]=d;return list};APPDateField.prototype._scrollTop=function(elObj,y,flag){var flag=!flag?flag:true;if(flag){elObj.stop().animate({"top":y},500,function(){var mesc=y%self.step;if(mesc!=0){var top=self.step*Math.round(y/self.step)-(Math.abs(mesc)<self.step?0:self.step);$(this).animate({top:top})}})}else{elObj[0].style.top=y+"px"}zoomOBJ(elObj,y)};APPDateField.prototype._events=function(){var self=this;var app_y_con=self.app_y_con;var app_m_con=self.app_m_con;var app_d_con=self.app_d_con;var app_main=self.app_main;var appYCON_touch=new APPTouch(app_y_con[0],app_main[0],self.opts);var appMCON_touch=new APPTouch(app_m_con[0],app_main[0],self.opts);var appDCON_touch=new APPTouch(app_d_con[0],app_main[0],self.opts);self.app_btnOk.bind("touchend",holdEvent(self,self._complate));self.app_btnCancel.bind("touchend",holdEvent(self,self._cancel));self.app_btnOk.bind("touchstart",self.endEvent);self.app_btnCancel.bind("touchstart",self.endEvent)};APPDateField.prototype.endEvent=function(evt){evt.preventDefault();evt.stopPropagation()};APPDateField.prototype._complate=function(evt){var vlist=[];vlist.push(this.getYear());vlist.push(this.getMonth());vlist.push(this.getDate());this.currDate=vlist;this.setCurrentTXT(vlist);this.appWrap.style.display="none";this.complate.call(this,evt)};APPDateField.prototype._cancel=function(evt){this.appWrap.style.display="none"};APPDateField.prototype.dateFm=function(n){return(n<10)?"0"+n:n};root.APPDateField=APPDateField;var APPTouch=function(elmObj,elmObjParent,options){this.elm=elmObj;this.elmParent=elmObjParent;this.hasTouch="ontouchstart" in window||window.TouchEvent;this.isMobile=/Mobile/gi.test(navigator.userAgent);this.isTouchStart=false;this.options=options;this.vlist={year:this.options.year,month:this.options.month,date:this.options.date,hours:this.options.hours,minutes:this.options.minutes,seconds:this.options.seconds};this.startY=0;this.dy=0;this.h=$(this.elm).height();this.moveY=0;this.top=$(this.elm).position().top;this.step=gVars.step;this.fontSize=gVars.fontSize;this.offset={left:this.elmParent.offsetLeft,top:this.elmParent.offsetTop,width:$(this.elmParent).width(),height:$(this.elmParent).height()};this.startTime=Date.now||function getTime(){return new Date().getTime()};this._initEvent(elmObj)};APPTouch.prototype={_initEvent:function(_elmObj){if(this.hasTouch){_elmObj.addEventListener("touchstart",this,false);_elmObj.addEventListener("touchmove",this,false);_elmObj.addEventListener("touchend",this,false)}else{_elmObj.addEventListener("mousedown",this,false);_elmObj.addEventListener("mousemove",this,false);_elmObj.addEventListener("mouseup",this,false)}},handleEvent:function(evt){switch(evt.type){case"touchstart":this._start(evt.targetTouches[0],evt);break;case"touchmove":this._move(evt.changedTouches[0],evt);break;case"touchend":this._end(evt.changedTouches[0],evt);break;case"mousedown":this._start(evt);break;case"mousemove":this._move(evt);break;case"mouseup":this._end(evt);break}if(/SELECT|TEXTAREA|INPUT/.test(evt.target.tagName.toUpperCase())){evt.preventDefault()}evt.preventDefault();evt.stopPropagation()},_start:function(evt,parentE){this.isTouchStart=true;this.y=this.top=$(this.elm).position().top;this.h=$(this.elm).height();this.startY=this.top;this.moveY=evt.pageY;this.startTime=Date.now||function getTime(){return new Date().getTime()}},_move:function(evt,parentE){if(this.isTouchStart){var target=$(evt.target).parent("ul");target.find("li").css("fontSize",this.fontSize+"px");this.dy=this.y-(this.moveY-evt.pageY);var top=this._formateTop(this.dy);this._scrollTop(target[0],top,true);zoomOBJ(target,top)}},_end:function(evt,parentE){this.isTouchStart=false;var target=$(evt.target).parent("ul");var offset=evt.pageY-this.moveY;var curTop=this.y+offset;var speed=offset/(new Date().getTime()-this.startTime);if(Math.abs(speed)>0.5){curTop-=speed*this.step}var top=this._formateTop(curTop);this._scrollTop(target[0],top,false);zoomOBJ(target,top)},_formateTop:function(top){if(top>=(gVars.step*3)){top=(gVars.step*3)}else{if(Math.abs(top)>=this.h-(gVars.step*4)){top=-(this.h-(gVars.step*4))}else{return top}}this.y=top;return top},_scrollTop:function(el,y,flag){if(!el||el==""){return false}var y=y||0;var flag=flag&&true;var self=this;if(flag){el.style.top=y+"px"}else{$(el).stop().animate({top:y},10,function(){var mesc=y%gVars.step;if(mesc!=0){var top=gVars.step*Math.round(y/gVars.step)-(Math.abs(mesc)<gVars.step?0:gVars.step);$(this).animate({top:top});self.y=top}})}if(!self.isTouchStart){var num=supperNumber(Math.round($(el).position().top/gVars.step));var txt=$(el).find("li").eq(num).text();if($(el).hasClass("app-dateField-month-con")){self.vlist.month=parseInt(txt);var ynum=supperNumber(Math.round($(".app-dateField-year-con").position().top/gVars.step));self.vlist.year=parseInt($(".app-dateField-year-con").find("li").eq(ynum).text())}else{if($(el).hasClass("app-dateField-year-con")){self.vlist.year=parseInt(txt);var ynum=supperNumber(Math.round($(".app-dateField-month-con").position().top/gVars.step));self.vlist.month=parseInt($(".app-dateField-month-con").find("li").eq(ynum).text())}else{self.vlist.date=parseInt(txt);var ynum=supperNumber(Math.round($(".app-dateField-year-con").position().top/gVars.step));self.vlist.year=parseInt($(".app-dateField-year-con").find("li").eq(ynum).text());var mnum=supperNumber(Math.round($(".app-dateField-month-con").position().top/gVars.step));self.vlist.month=parseInt($(".app-dateField-month-con").find("li").eq(mnum).text())}}if($(el).hasClass("app-dateField-month-con")||$(el).hasClass("app-dateField-year-con")){var pr=0;if(self.vlist.month==2){pr=(((self.vlist.year%4==0)&&(self.vlist.year%100!=0))||(self.vlist.year%400==0))?29:28;for(var i=0;i<31;i++){if(i>=pr){$(".app-dateField-date-con").find("li").eq(i).css("display","none")}}}else{for(var i=0;i<31;i++){$(".app-dateField-date-con").find("li").eq(i).css("display","block")}}}}}};var holdEvent=function(obj,func){var args=[];for(var i=2;i<arguments.length;i++){args.push(arguments[i])}return function(e){args.push(e);func.call(obj,e,args)}};var supperNumber=function(num){if(num==0){num=3}else{if(num>=1&&num<=3){if(num==1){num=2}else{if(num==2){num=1}else{if(num==3){num=0}}}}else{num=Math.abs(num)+3}}return num};var zoomOBJ=function(elObj,y){var index=Math.round(y/gVars.step);var count=Math.round(elObj.height()/gVars.step);var dd=gVars.fontSize;if(index>=count){index=count-1}else{if(index>=1&&index<=3){if(index==1){index=3-index}else{if(index==2){index=3-index}else{if(index==3){index=0}}}}else{if(index<=0){index=Math.abs(index)+3}}}for(var i=0;i<4;i++){var li=elObj.find("li").eq(index-i);if(li[0]){li[0].style.fontSize=dd+"px"}else{continue}dd-=3}dd=gVars.fontSize;for(var j=0;j<4;j++){var li=elObj.find("li").eq(index+j);if(li[0]){li[0].style.fontSize=dd+"px"}else{continue}dd-=3}}}).call(this);